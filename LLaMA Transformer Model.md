```
┌─────────────────────────────────────────────────────────────────┐
│                        LLaMA Transformer Model                  │                                    
└─────────────────────────────────────────────────────────────────┘
                              输入
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Token Embedding Layer                        │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐  def precompute_freqs_cis(dim: int, end: int, theta: float = 10000.0): 
│                 Rotary Position Encoding(RoPE)                  │    ...
└─────────────────────────────────────────────────────────────────┘    return freqs_cis
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Transformer Blocks (× n_layers)              │
├─────────────────────────────────────────────────────────────────┤
│  ┌────────────────────────────────────────────────────────────┐ │
│  │                    Transformer Block                       │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │              Residual Connection 1                  │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  │                            ↓                               │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │                  RMSNorm (Attention)                │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  │                            ↓                               │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │                Multi-Head Attention                 │   │ │
│  │  │  ┌─────────────┬─────────────┬─────────────┐        │   │ │
│  │  │  │      Wq     │      Wk     │      Wv     │        │   │ │
│  │  │  │ (ColumnPar) │ (ColumnPar) │ (ColumnPar) │        │   │ │
│  │  │  └─────────────┴─────────────┴─────────────┘        │   │ │
│  │  │         ↓             ↓             ↓               │   │ │
│  │  │    ┌─────────────────────────┐      ↓               │   │ │
│  │  │    │   Apply Rotary Embed    │      ↓               │   │ │
│  │  │    └─────────────────────────┘      ↓               │   │ │
│  │  │                ↓                    ↓               │   │ │
│  │  │    ┌────────────────────────┐       ↓               │   │ │
│  │  │    │ scores = torch.matmul  │       ↓               │   │ │
│  │  │    └────────────────────────┘       ↓               │   │ │
│  │  │             mask ↓                  ↓               │   │ │
│  │  │    ┌────────────────────────┐       ↓               │   │ │
│  │  │    │scores = softmax(scores)│       ↓               │   │ │
│  │  │    └────────────────────────┘       ↓               │   │ │
│  │  │                   ↓                 ↓               │   │ │
│  │  │            ┌──────────────────────────────┐         │   │ │
│  │  │            │    output = torch.matmul     │         │   │ │
│  │  │            └──────────────────────────────┘         │   │ │
│  │  │                           ↓                         │   │ │
│  │  │  ┌───────────────────────────────────────────────┐  │   │ │
│  │  │  │                  Wo (RowPar)                  │  │   │ │
│  │  │  └───────────────────────────────────────────────┘  │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  │                            ↓                               │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │              Residual Connection 2                  │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  │                            ↓                               │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │                  RMSNorm (FFN)                      │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  │                            ↓                               │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │               FeedForward (SwiGLU)                  │   │ │
│  │  │  ┌─────────────┐   ┌─────────────┐   ┌───────────┐  │   │ │
│  │  │  │     W1      │   │     W3      │   │    W2     │  │   │ │
│  │  │  │ (ColumnPar) │   │ (ColumnPar) │   │ (RowPar)  │  │   │ │
│  │  │  └─────────────┘   └─────────────┘   └───────────┘  │   │ │
│  │  │        ↓               ↓                   ↑        │   │ │
│  │  │  ┌─────────┐     ┌─────────┐               │        │   │ │
│  │  │  │  SiLU   │     │  Linear │               │        │   │ │
│  │  │  └─────────┘     └─────────┘               │        │   │ │
│  │  │        ↓               ↓                   │        │   │ │
│  │  │  ┌─────────────────────────┐               │        │   │ │
│  │  │  │   Element-wise Multiply │───────────────┘        │   │ │
│  │  │  └─────────────────────────┘                        │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  │                            ↓                               │ │
│  │  ┌─────────────────────────────────────────────────────┐   │ │
│  │  │                      output                         │   │ │
│  │  └─────────────────────────────────────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────┘ │
│                            × n_layers                           │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                      Final RMSNorm                              │
└─────────────────────────────────────────────────────────────────┘
                                ↓
┌─────────────────────────────────────────────────────────────────┐
│                    Output Projection                            │
└─────────────────────────────────────────────────────────────────┘
                                ↓
                              输出
                      (仅最后一个token的logits)
```


